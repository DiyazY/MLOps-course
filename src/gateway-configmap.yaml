apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-config
  namespace: mlops-lab
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        upstream ml_backend {
            server ml-inference-service:5000;
        }

        server {
            listen 80;

            # Health check endpoint for the gateway itself
            location /health {
                return 200 'Gateway OK\n';
                add_header Content-Type text/plain;
            }

            # Route prediction requests to ML service
            location /predict {
                proxy_pass http://ml_backend/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Request-ID $request_id;
                proxy_connect_timeout 10s;
                proxy_read_timeout 30s;
            }

            # Status page
            location /status {
                return 200 'API Gateway v1.0\nBackend: ml-inference-service:5000\n';
                add_header Content-Type text/plain;
            }
        }
    }
